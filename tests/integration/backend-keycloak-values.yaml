# https://github.com/codecentric/helm-charts/tree/keycloak-17.0.1/charts/keycloak
image:
  # This is a CI env NOT a local env, so we expect the registry to be ghcr.io
  repository: ghcr.io/opentdf/keycloak
  tag: head
  pullPolicy: Never # We expect Tilt to cache these
command:
  - "/opt/keycloak/bin/kc.sh"
  - "--verbose"
  - "start-dev"
postgresql:
  enabled: false
extraEnv: |
  - name: KEYCLOAK_ADMIN
    value: keycloakadmin
  - name: KEYCLOAK_ADMIN_PASSWORD
    value: mykeycloakpassword
  - name: KC_LOG_LEVEL
    value: TRACE
  - name: CLAIMS_URL
    value: http://opentdf-entitlement-pdp:3355/entitlements
  - name: KC_DB
    value: postgres
  - name: KC_DB_URL_HOST
    value: opentdf-postgresql
  - name: KC_DB_URL_DATABASE
    value: keycloak_database
  - name: KC_DB_URL_PORT
    value: "5432"
  - name: KC_HTTP_RELATIVE_PATH
    value: "/auth"
  - name: KC_HOSTNAME_STRICT_HTTPS
    value: "false"
  - name: KC_HOSTNAME_STRICT
    value: "false"
  - name: KC_HTTP_ENABLED
    value: "true"
  - name: KC_HTTP_ENABLED
    value: "true"
  - name: KC_HOSTNAME
    value: "localhost:65432"
  - name: KC_HOSTNAME_ADMIN
    value: "localhost:65432"
  - name: KC_PROXY
    value: "edge"
  - name: JAVA_OPTS_APPEND
    value: -Djgroups.dns.query={{ include "keycloak.fullname" . }}-headless
extraEnvFrom: |
  - secretRef:
      name: '{{ include "keycloak.fullname" . }}-db'
secrets:
  db:
    stringData:
      KC_DB_USERNAME: postgres
      KC_DB_PASSWORD: otdf-pgsql-admin
ingress:
  enabled: true
  ingressClassName: nginx
  rules:
    - host: localhost
      paths:
        - path: /auth(/|$)(.*)
          pathType: Prefix
    - host: host.docker.internal
      paths:
        - path: /auth(/|$)(.*)
          pathType: Prefix
  tls: null
