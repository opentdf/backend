name: 'opentdf-backend'

embedded:
  keycloak: true
  postgresql: true

boostrapKeycloak: true

# Global values that may be overridden by a parent chart.
global:
  opentdf:
    common:
      externalUrl: http://localhost:65432
      # The cluster internal scheme + hostname for keycloak endpoint, oidcUrlPrefix used in constructing end urls.
      oidcInternalHost: http://keycloak-http
      # The url path (no precedding / ) to keycloak
      oidcUrlPath: auth
      # The external scheme + hostname to keycloak endpoint, oidcUrlPrefix used in constructing end urls.
      oidcExternalHost: http://localhost:65432
      # Any existing image pull secrets subcharts should use
      # e.g.
      # imagePullSecrets:
      #   - name: my-existing-ghcr-pullsecret
      #   - name: my-other-pullsecret
      imagePullSecrets: []

secrets:
  opaPolicyPullSecret:
  oidcClientSecret:
  postgres:
    dbUser: postgres
    dbPassword: otdf-pgsql-admin
  keycloak:
    user: keycloakadmin
    password: mykeycloakpassword

attributes:
  fullnameOverride: opentdf-attributes
entitlement-pdp:
  opaConfig:
    policy:
      # `Tilt` tries make docker image caching automagic, but it isn't particularly
      # smart about non-Docker OCI caches, so tell the PDP chart to use the default on-disk policy bundle
      # we create and pack into the image to work around this
      useStaticPolicy: true
  config:
    disableTracing: true
entitlement-store:
  fullnameOverride: opentdf-entitlement-store
entitlements:
  fullnameOverride: opentdf-entitlements
entity-resolution:
  config:
    keycloak:
      legacy: true
kas:
  fullnameOverride: opentdf-kas
  endpoints:
    easHost: http://opentdf-attributes:4020
    statsdHost: opentdf-statsd
  envConfig:
    attrAuthorityCert:
    ecCert:
    cert:
    ecPrivKey:
    privKey:
  logLevel: DEBUG
  pdp:
    verbose: "true"
    disableTracing: "true"

keycloakx:
  fullnameOverride: keycloak
  image:
    # Keycloak is a non-OpenTDF chart, but with an OpenTDF image
    repository: ghcr.io/opentdf/keycloak
    tag: head
    pullPolicy: IfNotPresent
  command:
    - "/opt/keycloak/bin/kc.sh"
    - "--verbose"
    - "start-dev"
  postgresql:
    enabled: false
  externalDatabase:
    host: opentdf-postgresql
    database: keycloak_database
  extraEnv: |
    - name: KEYCLOAK_ADMIN
      value: keycloakadmin
    - name: KEYCLOAK_ADMIN_PASSWORD
      value: mykeycloakpassword
    - name: KC_LOG_LEVEL
      value: INFO
    - name: CLAIMS_URL
      value: http://opentdf-entitlement-pdp:3355/entitlements
    - name: KC_DB
      value: postgres
    - name: KC_DB_URL_HOST
      value: opentdf-postgresql
    - name: KC_DB_URL_DATABASE
      value: keycloak_database
    - name: KC_DB_URL_PORT
      value: "5432"
    - name: KC_DB_USERNAME
      value: postgres
    - name: KC_DB_PASSWORD
      value: myPostgresPassword
    - name: KC_HTTP_RELATIVE_PATH
      value: "/auth"
    - name: KC_HOSTNAME_STRICT_HTTPS
      value: "false"
    - name: KC_HOSTNAME_STRICT
      value: "false"
    - name: KC_HTTP_ENABLED
      value: "true"
    - name: KC_HOSTNAME
      value: "localhost:65432"
    - name: KC_HOSTNAME_ADMIN
      value: "localhost:65432"
    - name: KC_PROXY
      value: "edge"
    - name: JAVA_OPTS_APPEND
      value: -Djgroups.dns.query={{ include "keycloak.fullname" . }}-headless
  extraEnvFrom: |
    - secretRef:
        name: 'opentdf-keycloak-secret'
  ingress:
    enabled: true
    ingressClassName: nginx
    rules:
      - host: localhost
        paths: &paths
          - path: /auth(/|$)(.*)
            pathType: Prefix
      - host: host.docker.internal
        paths: *paths
      - host: offline.demo.internal
        paths: *paths
      - host: opentdf.local
        paths: *paths
    tls: []

keycloak-bootstrap:

  keycloak:
    username: keycloakadmin
    password: mykeycloakpassword
    clientId: tdf-client
    clientSecret: 123-456
    realm: tdf

  attributes:
    hostname: http://opentdf-attributes:4020
    realm: tdf
    clientId: dcr-test
    username: user1
    password: testuser123
    preloadedAuthorities:
    - https://example.com
    preloadedAttributes:
    - authority: https://example.com
      name: Classification
      rule: hierarchy
      state: published
      order:
      - TS
      - S
      - C
      - U
    - authority: https://example.com
      name: COI
      rule: allOf
      state: published
      order:
      - PRX
      - PRA
      - PRB
      - PRC
      - PRD
      - PRF

  entitlements:
    hostname: http://opentdf-entitlements:4030
    realms:
    - name: tdf
      clientId: dcr-test
      username: user1
      password: testuser123
      preloadedClaims:
        alice_1234:
          - https://example.com/attr/Classification/value/C
          - https://example.com/attr/COI/value/PRD
        bob_1234:
          - https://example.com/attr/Classification/value/C
          - https://example.com/attr/COI/value/PRC
        browsertest:
          - https://example.com/attr/Classification/value/C
          - https://example.com/attr/COI/value/PRA
        client_x509:
          - https://example.com/attr/Classification/value/S
          - https://example.com/attr/COI/value/PRX
        dcr-test:
          - https://example.com/attr/Classification/value/C
          - https://example.com/attr/COI/value/PRF
        service-account-tdf-client:
          - https://example.com/attr/Classification/value/C
          - https://example.com/attr/COI/value/PRB
        tdf-client:
          - https://example.com/attr/Classification/value/S
          - https://example.com/attr/COI/value/PRX
          - https://example.com/attr/Env/value/CleanRoom
        tdf-user:
          - https://example.com/attr/Classification/value/C
          - https://example.com/attr/COI/value/PRX
        user1:
          - https://example.com/attr/Classification/value/S
          - https://example.com/attr/COI/value/PRX

postgresql:
  #  configuration https://github.com/bitnami/charts/tree/master/bitnami/postgresql/#parameters
  fullnameOverride: opentdf-postgresql
  image:
    debug: true
  existingSecret: opentdf-postgres-secret
  initdbUser: postgres
  initdbScriptsSecret: opentdf-postgresql-initdb-secret
