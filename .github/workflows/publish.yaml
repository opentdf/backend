name: Publish

env:
  ARGO_SERVER: "argo.mgmt-green.virtru.com:443"
  ARGO_HTTP1: "true"
  ARGO_SECURE: "true"
  ARGO_BASE_HREF: "/argo/"
  ARGO_NAMESPACE: "argo"

defaults:
  run:
    shell: bash
on:
  workflow_call:
    secrets:
      MARS_AWS_ACCESS_KEY_ID:
        required: true
      MARS_AWS_SECRET_ACCESS_KEY:
        required: true
      MARS_AWS_ROLE_TO_ASSUME:
        required: true

jobs:
  # Tags every artifact with the current branch's gitref
  # and publishes it, for testing purposes
  # Does not deploy anything or update the repo, just
  # tags and pushes artifacts
  pr_publish:
    if: github.repository == 'opentdf/backend'
    runs-on: ubuntu-latest
    timeout-minutes: 45 #Potentially unneeded, testing to see if this helps with random 401 failures
    name: PR Publish by Gitref
    steps:
      - name: checkout
        uses: actions/checkout@v2

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.MARS_AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.MARS_AWS_SECRET_ACCESS_KEY }}
          aws-region: us-west-2
          role-to-assume: ${{ secrets.MARS_AWS_ROLE_TO_ASSUME }}
          role-external-id: GitHubAction
          role-duration-seconds: 2700
          role-session-name: opentdf-backend-action
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1
      - name: Argo publish
        uses: ./.github/actions/argo-pr-publish
